<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Photo Gallery</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: Arial, sans-serif; background: #f0f2f5; padding: 20px; }
    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
    .photos-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 16px; }
    .photo-thumbnail { border-radius: 12px; overflow: hidden; cursor: pointer; background: #ddd; aspect-ratio: 1 / 1; position: relative; }
    .photo-thumbnail img { width: 100%; height: 100%; object-fit: cover; display: block; }
    .lightbox { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 1000; align-items: center; justify-content: center; padding: 20px; }
    .lightbox.active { display: flex; }
    .lightbox-content { width: min(1000px, 96%); background: #fff; border-radius: 12px; padding: 16px; position: relative; }
    .lightbox-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .close-btn { background: #333; color: #fff; border: none; border-radius: 6px; width: 34px; height: 34px; cursor: pointer; }
    .lightbox-media { text-align: center; max-height: 70vh; display: flex; align-items: center; justify-content: center; }
    .lightbox-media img, .lightbox-media video { max-width: 100%; max-height: 60vh; display: block; }
    .nav-arrow { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.4); color: #fff; border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; }
    .nav-prev { left: 8px; }
    .nav-next { right: 8px; }
    .details { margin-top: 12px; display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 12px; }
    .detail { padding: 8px; border: 1px solid #ddd; border-radius: 8px; background: #fafafa; }
    .storage { margin-top: 20px; font-size: 0.95em; color: #555; text-align: center; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Photo Gallery</h1>
    <div id="albumInfo" class="album-info" style="text-align:center; padding:8px; border-radius:8px; display:none;"></div>
    <div id="photosGrid" class="photos-grid"></div>

    <div id="noPhotos" style="display:none; text-align:center; color:#666; margin-top:20px;">
      No photos in this album.
    </div>
  </div>

  <!-- Lightbox -->
  <div id="lightbox" class="lightbox" aria-hidden="true">
    <div class="lightbox-content" role="dialog" aria-label="Photo viewer">
      <div class="lightbox-header">
        <button id="closeBtn" class="close-btn" aria-label="Close">&times;</button>
      </div>
      <div id="lightboxMedia" class="lightbox-media"></div>
      <button class="nav-arrow nav-prev" id="navPrev" aria-label="Previous">‹</button>
      <button class="nav-arrow nav-next" id="navNext" aria-label="Next">›</button>
      <div class="details" id="lightboxDetails" style="margin-top:12px;">
        <div class="detail"><strong>Name:</strong> <span id="detailName"></span></div>
        <div class="detail"><strong>Uploader:</strong> <span id="detailUploader"></span></div>
        <div class="detail"><strong>Date:</strong> <span id="detailDate"></span></div>
        <div class="detail"><strong>Time:</strong> <span id="detailTime"></span></div>
        <div class="detail"><strong>Size:</strong> <span id="detailSize"></span></div>
      </div>
    </div>
  </div>

  <script>
    // Configuration / storage keys
    const STORAGE_KEY = 'PHOTO_ALBUMS_V1';

    // State
    let albums = {}; // { [albumId]: [ { id, name, dataUrl, uploader, timestamp, size } ] }
    let allPhotos = []; // current album photos
    let currentAlbumId = null;
    let currentPhotoIndex = 0;

    // DOM refs
    const photosGrid = document.getElementById('photosGrid');
    const noPhotos = document.getElementById('noPhotos');
    const lightbox = document.getElementById('lightbox');
    const lightboxMedia = document.getElementById('lightboxMedia');
    const detailName = document.getElementById('detailName');
    const detailUploader = document.getElementById('detailUploader');
    const detailDate = document.getElementById('detailDate');
    const detailTime = document.getElementById('detailTime');
    const detailSize = document.getElementById('detailSize');
    const closeBtn = document.getElementById('closeBtn');
    const navPrev = document.getElementById('navPrev');
    const navNext = document.getElementById('navNext');
    const albumInfo = document.getElementById('albumInfo');

    // Initialize with sample data if empty
    function loadFromStorage() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (raw) {
          albums = JSON.parse(raw);
        } else {
          // Seed with sample album
          albums = {
            "album1": [
              { id: "p1", name: "Sunset", dataUrl: "https://images.unsplash.com/photo-1506765515384-028b60a970df?q=80&w=1200&auto=format&fit=crop", uploader: "Guest", timestamp: Date.now() - 1000 * 60 * 60 * 24 * 2, size: 253000 },
              { id: "p2", name: "Forest", dataUrl: "https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?q=80&w=1200&auto=format&fit=crop", uploader: "Guest", timestamp: Date.now() - 1000 * 60 * 60 * 24, size: 312000 },
              { id: "p3", name: "Cityscape", dataUrl: "https://images.unsplash.com/photo-1491553895911-0055eca6402d?q=80&w=1200&auto=format&fit=crop", uploader: "Guest", timestamp: Date.now() - 1000 * 60 * 60 * 12, size: 289000 },
              { id: "p4", name: "Video Demo", dataUrl: "https://www.w3schools.com/html/mov_bbb.mp4", uploader: "Guest", timestamp: Date.now() - 1000 * 60 * 60 * 3, size: 1024000 },
            ]
          };
          localStorage.setItem(STORAGE_KEY, JSON.stringify(albums));
        }
      } catch (e) {
        console.error('Error loading storage', e);
        albums = {};
      }
    }

    function formatDate(ts) {
      const d = new Date(ts);
      return d.toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' });
    }

    function formatTime(ts) {
      const d = new Date(ts);
      return d.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    }

    function saveAlbums() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(albums));
    }

    function renderAlbum(albumId) {
      currentAlbumId = albumId;
      allPhotos = Array.isArray(albums[albumId]) ? albums[albumId] : [];
      // Sort newest first
      allPhotos.sort((a, b) => b.timestamp - a.timestamp);

      // Clear grid
      photosGrid.innerHTML = '';
      if (allPhotos.length === 0) {
        noPhotos.style.display = 'block';
        albumInfo.style.display = 'none';
        return;
      } else {
        noPhotos.style.display = 'none';
      }

      albumInfo.style.display = 'block';
      albumInfo.textContent = `Album: ${albumId} • ${allPhotos.length} photo(s)`;

      allPhotos.forEach((p, idx) => {
        addPhotoThumbnail(p, idx);
      });
    }

    function addPhotoThumbnail(photo, index) {
      const thumb = document.createElement('div');
      thumb.className = 'photo-thumbnail';
      thumb.id = `thumb-${photo.id}`;
      const media = document.createElement(photo.dataUrl.startsWith('video') ? 'video' : 'img');
      if (media.tagName === 'VIDEO') {
        media.src = photo.dataUrl;
        media.controls = false;
        media.setAttribute('playsinline', '');
        media.muted = true;
        media.loop = true;
      } else {
        media.src = photo.dataUrl;
        media.alt = photo.name;
        media.loading = 'lazy';
      }
      thumb.appendChild(media);
      thumb.addEventListener('click', () => openLightbox(index));

      photosGrid.appendChild(thumb);
    }

    function openLightbox(index) {
      currentPhotoIndex = index;
      displayLightboxPhoto();
      lightbox.classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    function closeLightbox() {
      lightbox.classList.remove('active');
      document.body.style.overflow = 'auto';
      // Clear media to stop playback
      lightboxMedia.innerHTML = '';
    }

    function displayLightboxPhoto() {
      const photo = allPhotos[currentPhotoIndex];
      if (!photo) return;

      // Clear content
      lightboxMedia.innerHTML = '';

      const isVideo = photo.dataUrl.startsWith('http') && photo.dataUrl.endsWith('.mp4') || photo.dataUrl.endsWith('.webm');

      // Media
      if (isVideo) {
        const video = document.createElement('video');
        video.src = photo.dataUrl;
        video.controls = true;
        video.autoplay = true;
        video.style.maxWidth = '100%';
        video.style.maxHeight = '60vh';
        lightboxMedia.appendChild(video);
      } else {
        const img = document.createElement('img');
        img.src = photo.dataUrl;
        img.alt = photo.name;
        lightboxMedia.appendChild(img);
      }

      // Details
      detailName.textContent = photo.name;
      detailUploader.textContent = photo.uploader || 'Unknown';
      detailDate.textContent = formatDate(photo.timestamp);
      detailTime.textContent = formatTime(photo.timestamp);
      detailSize.textContent = Math.round(photo.size / 1024) + ' KB';
    }

    function nextPhoto() {
      if (allPhotos.length === 0) return;
      currentPhotoIndex = (currentPhotoIndex + 1) % allPhotos.length;
      displayLightboxPhoto();
    }

    function prevPhoto() {
      if (allPhotos.length === 0) return;
      currentPhotoIndex = (currentPhotoIndex - 1 + allPhotos.length) % allPhotos.length;
      displayLightboxPhoto();
    }

    function deleteLightboxPhoto() {
      if (!allPhotos.length) return;

      if (!confirm('Are you sure you want to delete this photo?')) return;

      const photo = allPhotos[currentPhotoIndex];
      // Remove from current album
      allPhotos.splice(currentPhotoIndex, 1);
      albums[currentAlbumId] = allPhotos;
      saveAlbums();

      // Remove thumbnail
      const thumb = document.getElementById(`thumb-${photo.id}`);
      if (thumb) thumb.remove();

      if (allPhotos.length === 0) {
        closeLightbox();
        noPhotos.style.display = 'block';
        albumInfo.style.display = 'none';
        updateStorageInfo(0);
      } else {
        currentPhotoIndex = Math.min(currentPhotoIndex, allPhotos.length - 1);
        displayLightboxPhoto();
        updateStorageInfo(allPhotos.length);
      }
    }

    function updateStorageInfo(count) {
      // Basic storage snapshot
      const sizeSum = Object.values(albums).flat().reduce((acc, p) => acc + (p.size || 0), 0);
      const kb = Math.round(sizeSum / 1024);
      const text = `${count} photos • ${kb} KB storage used`;
      document.title = text;
    }

    // Keyboard controls
    document.addEventListener('keydown', (e) => {
      if (lightbox.classList.contains('active')) {
        if (e.key === 'Escape') closeLightbox();
        if (e.key === 'ArrowRight') nextPhoto();
        if (e.key === 'ArrowLeft') prevPhoto();
      }
    });

    lightbox.addEventListener('click', (e) => {
      if (e.target === lightbox) closeLightbox();
    });

    closeBtn.addEventListener('click', closeLightbox);
    navPrev.addEventListener('click', prevPhoto);
    navNext.addEventListener('click', nextPhoto);

    // Expose a simple API to switch albums (for your page integration)
    // You can bind this to UI controls (e.g., album selectors)
    function loadAlbumById(albumId) {
      if (!albums[albumId]) {
        albums[albumId] = [];
        saveAlbums();
      }
      renderAlbum(albumId);
    }

    // Initialization
    window.addEventListener('DOMContentLoaded', () => {
      loadFromStorage();
      // If you have a specific album to show on load, use it here:
      const firstAlbum = Object.keys(albums)<a href="" class="citation-link" target="_blank" style="vertical-align: super; font-size: 0.8em; margin-left: 3px;">[0]</a>;
      if (firstAlbum) {
        renderAlbum(firstAlbum);
      } else {
        // No albums yet
        noPhotos.style.display = 'block';
      }
      // Optional: show a default album info block
      albumInfo.style.display = 'block';
    });
  </script>
</body>
</html>
